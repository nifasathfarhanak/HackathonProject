<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Test Case Generator</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .page-layout {
            display: flex;
            flex-direction: row;
            gap: 20px;
            align-items: flex-start;
            height: calc(100vh - 150px); /* Adjust based on header height */
        }
        .sidebar {
            width: 35%;
            min-width: 450px;
            height: 100%;
            overflow-y: auto; /* Add scrollbar to sidebar */
            padding-right: 10px;
        }
        .main-content-area {
            width: 65%;
            height: 100%;
            overflow-y: auto; /* Add scrollbar to main content */
        }
        .boxed-section {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI-Powered Test Case Generator (TCGS)</h1>
            <p>Upload a software requirement document to begin.</p>
        </header>

        <div class="page-layout">
            <!-- Left Pane: Sidebar -->
            <div class="sidebar">
                <div id="dashboard" class="dashboard-section">
                    <h2>Results Dashboard</h2>
                    <div style="width: 100%; margin: auto; margin-bottom: 20px;">
                        <canvas id="dashboard-chart"></canvas>
                    </div>
                    <div style="width: 100%; margin: auto;">
                        <canvas id="test-type-chart"></canvas>
                    </div>
                </div>
                <div id="agent-builder-chat-container" class="chat-section">
                    <h2>Edit Test Cases with AI</h2>
                    <div id="chat-history"></div>
                    <form id="chat-form">
                        <input type="text" id="chat-input" placeholder="e.g., 'Change the priority of TC-001 to Low'" required>
                        <button type="submit">Send</button>
                    </form>
                </div>
                 <div id="ambiguity-report-container" class="ambiguity-section hidden">
                    <h2>AI-Powered Ambiguity Report</h2>
                    <p>The AI has analyzed your document for potential ambiguities. Download the report for details.</p>
                    <div id="ambiguity-download-buttons">
                        <button class="download-btn" id="download-ambiguity-txt">Download as TXT</button>
                    </div>
                </div>
                <div class="download-section">
                    <h2>Download Test Cases</h2>
                    <div id="download-buttons">
                        <button class="download-btn" data-format="csv">Download as CSV</button>
                        <button class="download-btn" data-format="xlsx">Download as XLSX</button>
                        <button class="download-btn" data-format="txt">Download as TXT</button>
                    </div>
                </div>
                <div class="jira-section">
                    <h2>Export to Jira (Manual)</h2>
                    <form id="jira-form">
                        <div class="jira-grid">
                            <input type="text" id="manual-jira-server" placeholder="Jira Server URL" value="https://nifasathfarhanak.atlassian.net">
                            <input type="email" id="manual-jira-email" placeholder="Jira Email" value="nifasathfarhanak@gmail.com">
                            <input type="password" id="manual-jira-token" placeholder="Jira API Token" value="ATATT3xFfGF08wgzjrbDiY5Zo1ICBGbVjJaEGHCedN1iQl17dBmx_Vae5qCy21v7z45rvht-bVP6ZApW6xn0pUd81NAbf6HGFk-I_qk7GkDkBOLTiBr-xBUXnBUnUBi3twMjwMm5Un87PwHYeoI-BE_M-AoRSg-jQaZuGhNWSBtWc2ixGn4AVfo=364D2636">
                            <input type="text" id="manual-jira-project-key" placeholder="Jira Project Key" value="SCRUM">
                            <input type="password" id="manual-zephyr-api-token" name="manual_zephyr_api_token" placeholder="Zephyr Scale API Token" value="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJjb250ZXh0Ijp7ImJhc2VVcmwiOiJodHRwczovL25pZmFzYXRoZmFyaGFuYWsuYXRsYXNzaWFuLm5ldCIsInVzZXIiOnsiYWNjb3VudElkIjoiNzEyMDIwOjI0MTMzM2EzLWNlODctNDNhZi1iOTIzLWYyZjA1MTRmM2QxZCIsInRva2VuSWQiOiJhZjQ5NDI4Yy1lNDVkLTQ4MDMtYjM0OC1hNGEwYTg1ZjlmN2YifX0sImlzcyI6ImNvbS5rYW5vYWgudGVzdC1tYW5hZ2VyIiwic3ViIjoiMjRjYmZiMzAtNDY5My0zZjZmLWEzMTAtNTZkOWI2NDM1MTdhIiwiZXhwIjoxNzkzNjMwMTU1LCJpYXQiOjE3NjIwOTQxNTV9.TVO1GQzhn3XK8-4GzZN2qkEE8VauB9Xt9vCDkhmJ14o">
                        </div>
                        <div class="zephyr-config">
                            <input type="checkbox" id="manual-jira-zephyr-api-integration" name="manual_is_zephyr_api_integration">
                            <label for="manual-jira-zephyr-api-integration">Use Zephyr Scale API Integration</label>
                        </div>
                        <div class="firebase-config">
                            <input type="checkbox" id="manual-save-to-firebase" name="manual_save_to_firebase">
                            <label for="manual-save-to-firebase">Save to Firebase</label>
                        </div>
                        <button type="submit">Create Jira Issues Manually</button>
                    </form>
                    <div id="jira-status"></div>
                </div>
            </div>

            <!-- Right Pane: Main Content -->
            <div class="main-content-area">
                <div class="upload-section">
                    <h2>1. Upload Document & Configure</h2>
                    <form id="upload-form" enctype="multipart/form-data">
                        <input type="file" id="file-input" name="requirement_file" accept=".pdf,.docx,.xml,.md,.txt" required>
                        
                        <div class="jira-grid">
                            <input type="text" id="jira-server" name="jira_server" placeholder="Jira Server URL" value="https://nifasathfarhanak.atlassian.net">
                            <input type="email" id="jira-email" name="jira_email" placeholder="Jira Email" value="nifasathfarhanak@gmail.com">
                            <input type="password" id="jira-token" name="jira_token" placeholder="Jira API Token" value="ATATT3xFfGF08wgzjrbDiY5Zo1ICBGbVjJaEGHCedN1iQl17dBmx_Vae5qCy21v7z45rvht-bVP6ZApW6xn0pUd81NAbf6HGFk-I_qk7GkDkBOLTiBr-xBUXnBUnUBi3twMjwMm5Un87PwHYeoI-BE_M-AoRSg-jQaZuGhNWSBtWc2ixGn4AVfo=364D2636">
                            <input type="text" id="jira-project-key" name="jira_project_key" placeholder="Jira Project Key" value="SCRUM">
                            <input type="password" id="zephyr-api-token" name="zephyr_api_token" placeholder="Zephyr Scale API Token" value="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJjb250ZXh0Ijp7ImJhc2VVcmwiOiJodHRwczovL25pZmFzYXRoZmFyaGFuYWsuYXRsYXNzaWFuLm5ldCIsInVzZXIiOnsiYWNjb3VudElkIjoiNzEyMDIwOjI0MTMzM2EzLWNlODctNDNhZi1iOTIzLWYyZjA1MTRmM2QxZCIsInRva2VuSWQiOiJhZjQ5NDI4Yy1lNDVkLTQ4MDMtYjM0OC1hNGEwYTg1ZjlmN2YifX0sImlzcyI6ImNvbS5rYW5vYWgudGVzdC1tYW5hZ2VyIiwic3ViIjoiMjRjYmZiMzAtNDY5My0zZjZmLWEzMTAtNTZkOWI2NDM1MTdhIiwiZXhwIjoxNzkzNjMwMTU1LCJpYXQiOjE3NjIwOTQxNTV9.TVO1GQzhn3XK8-4GzZN2qkEE8VauB9Xt9vCDkhmJ14o">
                        </div>

                        <div class="zephyr-config">
                            <input type="checkbox" id="jira-zephyr-api-integration" name="is_zephyr_api_integration">
                            <label for="jira-zephyr-api-integration">Use Zephyr Scale API Integration</label>
                        </div>
                        <div class="firebase-config">
                            <input type="checkbox" id="save-to-firebase" name="save_to_firebase">
                            <label for="save-to-firebase">Save to Firebase</label>
                        </div>
                        <div id="upload-jira-status"></div>
                        <button type="submit">Generate & Analyze Test Cases</button>
                    </form>
                </div>

                <div id="loading" class="hidden">
                    <p id="loading-message">Processing... This may take a few moments.</p>
                </div>

                <div id="results" class="hidden">
                    <div class="boxed-section">
                        <h2>Generated Test Cases <span class="quality-legend">(<span class="highlight-fail"></span>Needs Review)</span></h2>
                        <div id="test-case-table-container"></div>
                    </div>
                    <div class="boxed-section">
                        <h2>Extracted Text</h2>
                        <textarea id="extracted-text" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('upload-form');
        const loadingDiv = document.getElementById('loading');
        const loadingMessage = document.getElementById('loading-message');
        const resultsDiv = document.getElementById('results');
        const extractedTextEl = document.getElementById('extracted-text');
        const testCaseContainer = document.getElementById('test-case-table-container');
        const uploadJiraStatusDiv = document.getElementById('upload-jira-status');
        const ambiguityReportContainer = document.getElementById('ambiguity-report-container');
        const ambiguityDownloadButtons = document.getElementById('ambiguity-download-buttons');
        const dashboardChartCanvas = document.getElementById('dashboard-chart');
        const testTypeChartCanvas = document.getElementById('test-type-chart');
        let dashboardChart = null;
        let testTypeChart = null;

        let generatedTestCases = [];

        const jiraZephyrApiIntegrationCheckbox = document.getElementById('jira-zephyr-api-integration');
        const saveToFirebaseCheckbox = document.getElementById('save-to-firebase');
        const manualJiraZephyrApiIntegrationCheckbox = document.getElementById('manual-jira-zephyr-api-integration');
        const manualSaveToFirebaseCheckbox = document.getElementById('manual-save-to-firebase');


        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('file-input');
            if (!fileInput.files.length) { alert('Please select a file.'); return; }

            const formData = new FormData(uploadForm);

            resultsDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            uploadJiraStatusDiv.innerHTML = '';
            ambiguityReportContainer.classList.add('hidden');
            
            const messages = [
                'Parsing document...',
                'Detecting requirement ambiguities with AI...',
                'Generating test cases with Google AI...',
                'Running quality checks...',
                'Finalizing results...'
            ];
            let messageIndex = 0;
            loadingMessage.textContent = messages[messageIndex];
            const messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % messages.length;
                loadingMessage.textContent = messages[messageIndex];
            }, 3000);


            try {
                const response = await fetch('/generate_and_analyze', { method: 'POST', body: formData });
                
                clearInterval(messageInterval);
                loadingMessage.textContent = 'Processing complete!';

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'An unknown error occurred.');
                }

                extractedTextEl.value = data.extracted_text;
                generatedTestCases = data.test_cases;
                renderTestCases(generatedTestCases);
                
                if (data.ambiguity_report && data.ambiguity_report.length > 0) {
                    ambiguityReportContainer.classList.remove('hidden');
                }

                if (data.dashboard_stats) {
                    renderDashboardChart(data.dashboard_stats);
                    renderTestCaseTypeChart(generatedTestCases);
                }

                resultsDiv.classList.remove('hidden');

                if (data.jira_confirmations) {
                    let confirmationsHtml = '<h3>Jira Auto-Export Status</h3>';
                    data.jira_confirmations.forEach(msg => { confirmationsHtml += `<p class="jira-confirmation">${msg}</p>`; });
                    uploadJiraStatusDiv.innerHTML = confirmationsHtml;
                }
                 if (data.jira_error) {
                    uploadJiraStatusDiv.innerHTML = `<p class="error">Jira Auto-Export Error: ${data.jira_error}</p>`;
                }

                if (data.firebase_confirmations) {
                    let confirmationsHtml = uploadJiraStatusDiv.innerHTML + '<h3>Firebase Save Status</h3>';
                    data.firebase_confirmations.forEach(msg => { confirmationsHtml += `<p class="firebase-confirmation">${msg}</p>`; });
                    uploadJiraStatusDiv.innerHTML = confirmationsHtml;
                }


            } catch (error) {
                clearInterval(messageInterval);
                alert(`Error: ${error.message}`);
            } finally {
                loadingDiv.classList.add('hidden');
            }
        });


        function formatRtm(rtm) {
            if (!rtm) return 'N/A';
            if (typeof rtm === 'string') return rtm;
            if (typeof rtm === 'object') {
                const items = Array.isArray(rtm) ? rtm : [rtm];
                return items.map(item => item.rule_id || JSON.stringify(item)).join(', ');
            }
            return 'Invalid Format';
        }

        function renderTestCases(testCases) {
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Test Case ID</th>
                        <th>Requirement ID</th>
                        <th>Description</th>
                        <th>Test Type</th>
                        <th>Priority</th>
                        <th>RTM Compliance Mapping</th>
                        <th>Steps</th>
                        <th>Expected Result</th>
                        <th>Confidence</th>
                    </tr>
                </thead>
                <tbody>
                    ${testCases.map(tc => {
                        const assessment = tc.quality_assessment || { passed: true, checks: [] };
                        const failedChecks = assessment.checks.filter(c => !c.passed);
                        const rowClass = !assessment.passed ? 'quality-fail' : '';
                        const tooltip = !assessment.passed ? `Quality Issues Found:\n${failedChecks.map(c => `- ${c.check}: ${c.notes}`).join('\n')}` : 'Quality check passed.';
                        
                        return `
                        <tr class="${rowClass}" title="${tooltip}">
                            <td>${tc.test_case_id || 'N/A'}</td>
                            <td>${tc.requirement_id || 'N/A'}</td>
                            <td>${tc.description || 'N/A'}</td>
                            <td>${tc.test_type || 'N/A'}</td>
                            <td>${tc.priority || 'N/A'}</td>
                            <td>${formatRtm(tc.rtm_compliance_mapping)}</td>
                            <td><ol>${(tc.steps || []).map(step => `<li>${step}</li>`).join('')}</ol></td>
                            <td>${tc.expected_result || 'N/A'}</td>
                            <td>${tc.confidence_score || 'N/A'}</td>
                        </tr>
                    `}).join('')}
                </tbody>
            `;
            testCaseContainer.innerHTML = '';
            testCaseContainer.appendChild(table);
        }

        function renderDashboardChart(stats) {
            if (dashboardChart) {
                dashboardChart.destroy();
            }
            const needsReview = stats.total_generated - stats.valid_cases;
            dashboardChart = new Chart(dashboardChartCanvas, {
                type: 'pie',
                data: {
                    labels: ['Valid Test Cases', 'Needs Review'],
                    datasets: [{
                        label: 'Test Case Quality',
                        data: [stats.valid_cases, needsReview],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)', // Green
                            'rgba(255, 99, 132, 0.8)'  // Red
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Total Generated: ${stats.total_generated}`
                        }
                    }
                }
            });
        }

        function renderTestCaseTypeChart(testCases) {
            if (testTypeChart) {
                testTypeChart.destroy();
            }
            const typeCounts = testCases.reduce((acc, tc) => {
                const type = tc.test_type || 'Unknown';
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(typeCounts);
            const data = Object.values(typeCounts);

            testTypeChart = new Chart(testTypeChartCanvas, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Test Case Types',
                        data: data,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(201, 203, 207, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Test Case Type Distribution'
                        }
                    }
                }
            });
        }

        ambiguityDownloadButtons.addEventListener('click', (e) => {
            if (e.target.id === 'download-ambiguity-txt') {
                window.location.href = '/download_ambiguity_report?format=txt';
            }
        });

        
        const jiraForm = document.getElementById('jira-form');
        const jiraStatusDiv = document.getElementById('jira-status');
        const downloadButtonsDiv = document.getElementById('download-buttons');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatHistory = document.getElementById('chat-history');

        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender);
            messageDiv.textContent = text;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userPrompt = chatInput.value;
            if (!userPrompt.trim() || generatedTestCases.length === 0) {
                alert("Please generate test cases before trying to edit them.");
                return;
            }
            
            appendMessage(userPrompt, 'user');
            chatInput.value = '';
            appendMessage('Editing test cases with AI... ', 'bot-loading');

            try {
                const response = await fetch('/edit_test_cases', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ prompt: userPrompt, test_cases: generatedTestCases })
                });
                const data = await response.json();
                document.querySelector('.bot-loading').remove();

                if (!response.ok) { 
                    throw new Error(data.error || 'An unknown error occurred.'); 
                }

                appendMessage('Test cases updated successfully!', 'bot');
                generatedTestCases = data.test_cases;
                renderTestCases(generatedTestCases);

            } catch (error) {
                document.querySelector('.bot-loading').remove();
                appendMessage(`Error: ${error.message}`, 'bot-error');
            }
        });

        downloadButtonsDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('download-btn')) {
                const format = e.target.dataset.format;
                fetch(`/download?format=${format}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ test_cases: generatedTestCases }) })
                .then(res => {
                    if (!res.ok) { return res.json().then(err => { throw new Error(err.error) }); }
                    const disposition = res.headers.get('Content-Disposition');
                    const filenameMatch = disposition && disposition.match(/filename="?(.+)"?/);
                    const filename = filenameMatch ? filenameMatch[1] : `test-cases.${format}`;
                    return res.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => alert(`Download failed: ${error.message}`));
            }
        });

        jiraForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const isZephyrApiIntegrationManual = manualJiraZephyrApiIntegrationCheckbox.checked;
            const zephyrApiTokenManual = document.getElementById('manual-zephyr-api-token').value;
            const manualSaveToFirebase = manualSaveToFirebaseCheckbox.checked;

            const jiraConfig = { 
                server: document.getElementById('manual-jira-server').value, 
                email: document.getElementById('manual-jira-email').value, 
                token: document.getElementById('manual-jira-token').value, 
                project_key: document.getElementById('manual-jira-project-key').value, 
                test_cases: generatedTestCases,
                is_zephyr_api_integration: isZephyrApiIntegrationManual,
                zephyr_api_token: zephyrApiTokenManual,
                save_to_firebase: manualSaveToFirebase
            };
            if (!jiraConfig.server || !jiraConfig.email || !jiraConfig.token || !jiraConfig.project_key) { alert('Please fill in all Jira configuration details for manual export.'); return; }
            
            if (isZephyrApiIntegrationManual && !zephyrApiTokenManual) {
                alert('Please provide the Zephyr Scale API Token for API integration.');
                return;
            }

            jiraStatusDiv.innerHTML = '<p>Creating issues in Jira...</p>';
            try {
                const response = await fetch('/export_to_jira', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(jiraConfig) });
                const data = await response.json();
                
                if (!response.ok) { throw new Error(data.error || 'An unknown error occurred.'); }
                let confirmationsHtml = '<h3>Jira Export Status</h3>';
                data.confirmations.forEach(msg => { confirmationsHtml += `<p class="jira-confirmation">${msg}</p>`; });
                jiraStatusDiv.innerHTML = confirmationsHtml;

                if (data.firebase_confirmations) {
                    let confirmationsHtml = jiraStatusDiv.innerHTML + '<h3>Firebase Save Status</h3>';
                    data.firebase_confirmations.forEach(msg => { confirmationsHtml += `<p class="firebase-confirmation">${msg}</p>`; });
                    jiraStatusDiv.innerHTML = confirmationsHtml;
                }

            } catch (error) { jiraStatusDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`; }
        });
    </script>
</body>
</html>
