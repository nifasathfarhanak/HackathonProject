<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Test Case Generator</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>AI-Powered Test Case Generator (TCGS)</h1>
            <p>Upload a software requirement document to begin.</p>
        </header>

        <div class="main-content">
            <div class="upload-section">
                <h2>1. Upload Document & Configure</h2>
                <form id="upload-form" enctype="multipart/form-data">
                    <input type="file" id="file-input" name="requirement_file" accept=".pdf,.docx,.xml,.md,.txt" required>
                    
                    <div class="jira-grid">
                        <input type="text" id="jira-server" name="jira_server" placeholder="Jira Server URL" value="https://nifasathfarhanak.atlassian.net">
                        <input type="email" id="jira-email" name="jira_email" placeholder="Jira Email" value="nifasathfarhanak@gmail.com">
                        <input type="password" id="jira-token" name="jira_token" placeholder="Jira API Token" value="ATATT3xFfGF0OT61REUZ_87t1aWXJVZuo2H-J5V2u5JzCahuLPy6wZCPk3AdAeh5npLbTn8sgE62tTrN-0Od7BQD1_Ckrsd5Hmw7Z7ZCtpqsB6gljYSJjUz3zBp3vGbe94s5_3_H9o_rFKRoQbBZtQogQpL0kp23Yen9957WF49BlvGkr62A7bc=1CF574EE">
                        <input type="text" id="jira-project-key" name="jira_project_key" placeholder="Jira Project Key" value="SCRUM">
                        <input type="password" id="zephyr-api-token" name="zephyr_api_token" placeholder="Zephyr Scale API Token" value="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJjb250ZXh0Ijp7ImJhc2VVcmwiOiJodHRwczovL25pZmFzYXRoZmFyaGFuYS5hdGxhc3NpYW4ubmV0IiwidXNlciI6eyJhbGciOiJIUzI1NiJ9.eyJjb250ZXh0Ijp7ImJhc2VVcmwiOiJodHRwczovL25pZmFzYXRoZmFyaGFuYS5hdGxhc3NpYW4ubmV0IiwidXNlciI6eyJ\nhY2NvdW50SWQiOiI3MTIwMjA6MjQxMzMzYTMtY2U4Ny00M2FmLWI5MjMtZjJmMDUxNGY\nzZDFkIiwidG9rZW5JZCI6IjM0MjU0NmQyLTU5MzgtND\nE1ZC1iNDFmLTE0ODRhNTdjZmQ5MCJ9fSwiaXNzIjoiY29tLmthbm9haC50ZXN0LW1hbmFnZXIiLCJzdWIiOiIyNGNiZmIzMC00NjkzLTMzZjZmLWEzMTAtNTZkOWI2NDM1MTdhIiwiZXhwIjoxNzkzNTUwNTQ2LCJpYXQiOjE3NjIwMTQ1NDZ9.pilVfHeKTz-WTpe6FGZ5oIFAKL65PtuO9prDKcbwItY">
                    </div>
                    <div>
                        <input type="checkbox" id="jira-auto-export" name="jira_auto_export">
                        <label for="jira-auto-export">Automatically create Jira issues on generate</label>
                    </div>

                    <div class="zephyr-config">
                        <input type="checkbox" id="jira-zephyr-api-integration" name="is_zephyr_api_integration">
                        <label for="jira-zephyr-api-integration">Use Zephyr Scale API Integration</label>
                    </div>

                    <div class="firebase-config">
                        <input type="checkbox" id="save-to-firebase" name="save_to_firebase">
                        <label for="save-to-firebase">Save to Firebase</label>
                    </div>

                    <div id="upload-jira-status"></div>

                    <button type="submit">Generate & Analyze Test Cases</button>
                </form>
            </div>

            <div id="loading" class="hidden">
                <p id="loading-message">Processing... This may take a few moments.</p>
            </div>

            <div id="results" class="hidden">
                <div class="results-grid">
                    <div class="grid-item">
                        <h2>Extracted Text</h2>
                        <textarea id="extracted-text" readonly></textarea>
                    </div>
                    <div class="grid-item">
                        <h2>Generated Test Cases <span class="quality-legend">(<span class="highlight-fail"></span>Needs Review)</span></h2>
                        <div id="test-case-table-container"></div>
                    </div>
                </div>

                <div id="agent-builder-chat-container" class="chat-section">
                    <h2>Edit Test Cases with AI</h2>
                    <div id="chat-history"></div>
                    <form id="chat-form">
                        <input type="text" id="chat-input" placeholder="e.g., 'Change the priority of TC-001 to Low'" required>
                        <button type="submit">Send</button>
                    </form>
                </div>

                <div class="download-section">
                    <h2>Download Test Cases</h2>
                    <div id="download-buttons">
                        <button class="download-btn" data-format="csv">Download as CSV</button>
                        <button class="download-btn" data-format="xlsx">Download as XLSX</button>
                        <button class="download-btn" data-format="txt">Download as TXT</button>
                    </div>
                </div>
                
                <div class="jira-section">
                    <h2>Export to Jira (Manual)</h2>
                    <form id="jira-form">
                        <div class="jira-grid">
                            <input type="text" id="manual-jira-server" placeholder="Jira Server URL (e.g., https://your-domain.atlassian.net)" value="https://nifasathfarhanak.atlassian.net">
                            <input type="email" id="manual-jira-email" placeholder="Jira Email" value="nifasathfarhanak@gmail.com">
                            <input type="password" id="manual-jira-token" placeholder="Jira API Token" value="ATATT3xFfGF0OT61REUZ_87t1aWXJVZuo2H-J5V2u5JzCahuLPy6wZCPk3AdAeh5npLbTn8sgE62tTrN-0Od7BQD1_Ckrsd5Hmw7Z7ZCtpqsB6gljYSJjUz3zBp3vGbe94s5_3_H9o_rFKRoQbBZtQogQpL0kp23Yen9957WF49BlvGkr62A7bc=1CF574EE">
                            <input type="text" id="manual-jira-project-key" placeholder="Jira Project Key (e.g., PROJ)" value="SCRUM">
                            <input type="password" id="manual-zephyr-api-token" name="manual_zephyr_api_token" placeholder="Zephyr Scale API Token" value="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJjb250ZXh0Ijp7ImJhc2VVcmwiOiJodHRwczovL25pZmFzYXRoZmFyaGFuYWsuYXRsYXNzaWFuLm5ldCIsInVzZXIiOnsiYWNjb3VudElkIjoiNzEyMDIwOjI0MTMzM2EzLWNlODctNDNhZi1iOTIzLWYyZjA1MTRmM2QxZCIsInRva2VuSWQiOiI2MjFhOGQ3Ny1lYjZkLTRmNjYtOTUwMC01NTkxNDE1ZjhjYjkifX0sImlzcyI6ImNvbS5rYW5vYWgudGVzdC1tYW5hZ2VyIiwic3ViIjoiMjRjYmZiMzAtNDY5My0zZjZmLWEzMTAtNTZkOWI2NDM1MTdhIiwiZXhwIjoxNzkzNTUxNzIyLCJpYXQiOjE3NjIwMTU3MjJ9.ys7WKD4S3h2jZm-XxtvSe3pkfn5aI1TpCO3yq7AgO0Y">
                        </div>
                        <div class="zephyr-config">
                            <input type="checkbox" id="manual-jira-zephyr-api-integration" name="manual_is_zephyr_api_integration">
                            <label for="manual-jira-zephyr-api-integration">Use Zephyr Scale API Integration</label>
                        </div>
                        <div class="firebase-config">
                            <input type="checkbox" id="manual-save-to-firebase" name="manual_save_to_firebase">
                            <label for="manual-save-to-firebase">Save to Firebase</label>
                        </div>
                        <button type="submit">Create Jira Issues Manually</button>
                    </form>
                    <div id="jira-status"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('upload-form');
        const loadingDiv = document.getElementById('loading');
        const loadingMessage = document.getElementById('loading-message');
        const resultsDiv = document.getElementById('results');
        const extractedTextEl = document.getElementById('extracted-text');
        const testCaseContainer = document.getElementById('test-case-table-container');
        const uploadJiraStatusDiv = document.getElementById('upload-jira-status');

        let generatedTestCases = [];

        // Zephyr config elements for auto-export
        const jiraZephyrApiIntegrationCheckbox = document.getElementById('jira-zephyr-api-integration');
        const zephyrApiTokenInput = document.getElementById('zephyr-api-token');

        // Firebase config elements for auto-export
        const saveToFirebaseCheckbox = document.getElementById('save-to-firebase');

        // Zephyr config elements for manual export
        const manualJiraZephyrApiIntegrationCheckbox = document.getElementById('manual-jira-zephyr-api-integration');
        const manualZephyrApiTokenInput = document.getElementById('manual-zephyr-api-token');

        // Firebase config elements for manual export
        const manualSaveToFirebaseCheckbox = document.getElementById('manual-save-to-firebase');


        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('file-input');
            if (!fileInput.files.length) { alert('Please select a file.'); return; }

            const formData = new FormData(uploadForm);
            const autoExport = document.getElementById('jira-auto-export').checked;
            const isZephyrApiIntegration = jiraZephyrApiIntegrationCheckbox.checked;
            const zephyrApiToken = zephyrApiTokenInput.value;
            const saveToFirebase = saveToFirebaseCheckbox.checked;

            console.log(`DEBUG: Frontend - saveToFirebaseCheckbox.checked: ${saveToFirebaseCheckbox.checked}`);
            console.log(`DEBUG: Frontend - saveToFirebase variable: ${saveToFirebase}`);

            // Add Zephyr specific fields to formData if checked
            if (isZephyrApiIntegration) {
                formData.append('is_zephyr_api_integration', 'true');
                if (!zephyrApiToken) {
                    alert('Please provide the Zephyr Scale API Token for API integration.');
                    loadingDiv.classList.add('hidden');
                    return;
                }
                formData.append('zephyr_api_token', zephyrApiToken);
            } else {
                formData.append('is_zephyr_api_integration', 'false'); // Explicitly send false if not checked
            }

            // Add Firebase specific field to formData if checked
            // This block was moved outside the `if (saveToFirebase)` condition
            // to ensure it's always appended, even if false.
            formData.append('save_to_firebase', saveToFirebase ? 'true' : 'false');


            resultsDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            uploadJiraStatusDiv.innerHTML = '';
            
            let msg = 'Processing... The AI is generating and validating test cases.';
            if(autoExport) {
                msg += ' Jira export will be attempted.';
                if (isZephyrApiIntegration) {
                    msg += ' (using Zephyr Scale API)';
                }
            }
            if(saveToFirebase) {
                msg += ' Firebase save will be attempted.';
            }
            loadingMessage.textContent = msg;


            try {
                const response = await fetch('/generate_and_analyze', { method: 'POST', body: formData });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'An unknown error occurred.');
                }

                extractedTextEl.value = data.extracted_text;
                generatedTestCases = data.test_cases;
                renderTestCases(generatedTestCases);
                resultsDiv.classList.remove('hidden');

                if (data.jira_confirmations) {
                    let confirmationsHtml = '<h3>Jira Auto-Export Status</h3>';
                    data.jira_confirmations.forEach(msg => { confirmationsHtml += `<p class="jira-confirmation">${msg}</p>`; });
                    uploadJiraStatusDiv.innerHTML = confirmationsHtml;
                }
                 if (data.jira_error) {
                    uploadJiraStatusDiv.innerHTML = `<p class="error">Jira Auto-Export Error: ${data.jira_error}</p>`;
                }

                if (data.firebase_confirmations) {
                    let confirmationsHtml = uploadJiraStatusDiv.innerHTML + '<h3>Firebase Save Status</h3>';
                    data.firebase_confirmations.forEach(msg => { confirmationsHtml += `<p class="firebase-confirmation">${msg}</p>`; });
                    uploadJiraStatusDiv.innerHTML = confirmationsHtml;
                }


            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                loadingDiv.classList.add('hidden');
            }
        });


        function formatRtm(rtm) {
            if (!rtm) return 'N/A';
            if (typeof rtm === 'string') return rtm;
            if (typeof rtm === 'object') {
                const items = Array.isArray(rtm) ? rtm : [rtm];
                return items.map(item => item.rule_id || JSON.stringify(item)).join(', ');
            }
            return 'Invalid Format';
        }

        function renderTestCases(testCases) {
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Test Case ID</th>
                        <th>Requirement ID</th>
                        <th>Description</th>
                        <th>Test Type</th>
                        <th>Priority</th>
                        <th>RTM Compliance Mapping</th>
                        <th>Steps</th>
                        <th>Expected Result</th>
                        <th>Confidence</th>
                    </tr>
                </thead>
                <tbody>
                    ${testCases.map(tc => {
                        const assessment = tc.quality_assessment || { passed: true, checks: [] };
                        const failedChecks = assessment.checks.filter(c => !c.passed);
                        const rowClass = !assessment.passed ? 'quality-fail' : '';
                        const tooltip = !assessment.passed ? `Quality Issues Found:\n${failedChecks.map(c => `- ${c.check}: ${c.notes}`).join('\n')}` : 'Quality check passed.';
                        
                        return `
                        <tr class="${rowClass}" title="${tooltip}">
                            <td>${tc.test_case_id || 'N/A'}</td>
                            <td>${tc.requirement_id || 'N/A'}</td>
                            <td>${tc.description || 'N/A'}</td>
                            <td>${tc.test_type || 'N/A'}</td>
                            <td>${tc.priority || 'N/A'}</td>
                            <td>${formatRtm(tc.rtm_compliance_mapping)}</td>
                            <td><ol>${(tc.steps || []).map(step => `<li>${step}</li>`).join('')}</ol></td>
                            <td>${tc.expected_result || 'N/A'}</td>
                            <td>${tc.confidence_score || 'N/A'}</td>
                        </tr>
                    `}).join('')}
                </tbody>
            `;
            testCaseContainer.innerHTML = '';
            testCaseContainer.appendChild(table);
        }

        
        const jiraForm = document.getElementById('jira-form');
        const jiraStatusDiv = document.getElementById('jira-status');
        const downloadButtonsDiv = document.getElementById('download-buttons');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatHistory = document.getElementById('chat-history');

        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender);
            messageDiv.textContent = text;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userPrompt = chatInput.value;
            if (!userPrompt.trim() || generatedTestCases.length === 0) {
                alert("Please generate test cases before trying to edit them.");
                return;
            }
            
            appendMessage(userPrompt, 'user');
            chatInput.value = '';
            appendMessage('Editing test cases with AI... ', 'bot-loading');

            try {
                const response = await fetch('/edit_test_cases', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ prompt: userPrompt, test_cases: generatedTestCases })
                });
                const data = await response.json();
                document.querySelector('.bot-loading').remove();

                if (!response.ok) { 
                    throw new Error(data.error || 'An unknown error occurred.'); 
                }

                appendMessage('Test cases updated successfully!', 'bot');
                generatedTestCases = data.test_cases;
                renderTestCases(generatedTestCases);

            } catch (error) {
                document.querySelector('.bot-loading').remove();
                appendMessage(`Error: ${error.message}`, 'bot-error');
            }
        });

        downloadButtonsDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('download-btn')) {
                const format = e.target.dataset.format;
                fetch(`/download?format=${format}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ test_cases: generatedTestCases }) })
                .then(res => {
                    if (!res.ok) { return res.json().then(err => { throw new Error(err.error) }); }
                    const disposition = res.headers.get('Content-Disposition');
                    const filenameMatch = disposition && disposition.match(/filename="?(.+)"?/);
                    const filename = filenameMatch ? filenameMatch[1] : `test-cases.${format}`;
                    return res.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => alert(`Download failed: ${error.message}`));
            }
        });

        jiraForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const isZephyrApiIntegrationManual = manualJiraZephyrApiIntegrationCheckbox.checked;
            const zephyrApiTokenManual = manualZephyrApiTokenInput.value;
            const manualSaveToFirebase = manualSaveToFirebaseCheckbox.checked;

            const jiraConfig = { 
                server: document.getElementById('manual-jira-server').value, 
                email: document.getElementById('manual-jira-email').value, 
                token: document.getElementById('manual-jira-token').value, 
                project_key: document.getElementById('manual-jira-project-key').value, 
                test_cases: generatedTestCases,
                is_zephyr_api_integration: isZephyrApiIntegrationManual,
                zephyr_api_token: zephyrApiTokenManual,
                save_to_firebase: manualSaveToFirebase
            };
            if (!jiraConfig.server || !jiraConfig.email || !jiraConfig.token || !jiraConfig.project_key) { alert('Please fill in all Jira configuration details for manual export.'); return; }
            
            if (isZephyrApiIntegrationManual && !zephyrApiTokenManual) {
                alert('Please provide the Zephyr Scale API Token for API integration.');
                return;
            }

            jiraStatusDiv.innerHTML = '<p>Creating issues in Jira...</p>';
            try {
                const response = await fetch('/export_to_jira', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(jiraConfig) });
                const data = await response.json();
                
                if (!response.ok) { throw new Error(data.error || 'An unknown error occurred.'); }
                let confirmationsHtml = '<h3>Jira Export Status</h3>';
                data.confirmations.forEach(msg => { confirmationsHtml += `<p class="jira-confirmation">${msg}</p>`; });
                jiraStatusDiv.innerHTML = confirmationsHtml;

                if (data.firebase_confirmations) {
                    let confirmationsHtml = jiraStatusDiv.innerHTML + '<h3>Firebase Save Status</h3>';
                    data.firebase_confirmations.forEach(msg => { confirmationsHtml += `<p class="firebase-confirmation">${msg}</p>`; });
                    jiraStatusDiv.innerHTML = confirmationsHtml;
                }

            } catch (error) { jiraStatusDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`; }
        });
    </script>
</body>
</html>
